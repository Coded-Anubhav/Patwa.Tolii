<!DOCTYPE html>
<!-- 
    Updated: 2025-05-09 20:04:42 UTC
    Last modified by: Coded-Anubhav
    Version: 2.0.0
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Patwa.Toli - A secure and accessible community platform">
    <meta name="theme-color" content="#4f46e5">
    <meta name="author" content="Coded-Anubhav">

    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' https: 'unsafe-inline' 'unsafe-eval' cdn.tailwindcss.com cdnjs.cloudflare.com; style-src 'self' https: 'unsafe-inline'; img-src 'self' https: data: blob:; font-src 'self' https: data:; connect-src 'self' https:; frame-src 'self' https:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <title>Patwa.Toli - Community Platform</title>

    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    
    <!-- Load critical CSS first -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
    
    <!-- Security Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js" integrity="sha512-YqYx4liWvwJ5gYPrqcCvark8Mcx6JDxA5OJ4o4/oJYbvWd5LO9J4IQmApDCVVGiTZ3z7igoOnc6lsQKp4QoMQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/validator/13.11.0/validator.min.js" integrity="sha512-qZqjcHHoG7ZGMqoEDYZ/yD2lrPxELqRxs9xIQkEzRYAh2SjO5Y+intercHJtg9H4QNL9ggFCidXxTwXnrZ3Dtdg==" crossorigin="anonymous"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Base Theme Variables */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --text-color: #111827;
            --secondary-text: #6b7280;
            --border-color: #e5e7eb;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --placeholder-color: #9ca3af;
        }

        /* Theme Variations */
        .theme-dark {
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --bg-color: #1f2937;
            --card-bg: #111827;
            --text-color: #f9fafb;
            --secondary-text: #d1d5db;
            --border-color: #374151;
            --input-bg: #1f2937;
            --input-border: #4b5563;
            --placeholder-color: #9ca3af;
        }

        .theme-blue {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #eff6ff;
            --card-bg: #ffffff;
        }

        .theme-green {
            --primary: #059669;
            --primary-hover: #047857;
            --bg-color: #ecfdf5;
            --card-bg: #ffffff;
        }

        /* Base Styles */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Accessibility Focus Styles */
        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Button Styles */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:focus-visible {
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
        }

        /* Form Controls */
        .form-control {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(var(--primary), 0.1);
            outline: none;
        }

        /* Custom Scrollbars */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(107, 114, 128, 0.3) transparent;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(107, 114, 128, 0.3);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(107, 114, 128, 0.5);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(var(--primary), 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Utilities */
        @media (max-width: 768px) {
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--card-bg);
                border-top: 1px solid var(--border-color);
                z-index: 50;
                padding: 0.5rem;
            }
        }

        /* Skip to main content - Accessibility */
        .skip-to-main {
            position: absolute;
            top: -100%;
            left: 0;
            padding: 1rem;
            background: var(--primary);
            color: white;
            z-index: 100;
            transition: top 0.3s;
        }

        .skip-to-main:focus {
            top: 0;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: var(--card-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Card Hover Effects */
        .hover-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .hover-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen theme-light">
    <!-- Skip to main content link - Accessibility -->
    <a href="#main-content" class="skip-to-main">
        Skip to main content
    </a>

    <!-- Login Container -->
    <div id="login-container" class="gradient-bg min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Patwa.Toli</h1>
                <p class="text-gray-600 mt-2">Connect with your community</p>
            </div>
            <form id="login-form" class="space-y-4" novalidate>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input 
                        type="email" 
                        id="login-email" 
                        required 
                        class="form-control"
                        aria-required="true"
                        autocomplete="email">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="login-password" 
                            required 
                            class="form-control"
                            aria-required="true"
                            autocomplete="current-password">
                        <button 
                            type="button"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                            aria-label="Toggle password visibility">
                            <i class="far fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="remember-me" 
                            class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                            aria-label="Remember me">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">
                            Remember me
                        </label>
                    </div>
                    <a href="#" class="text-sm text-primary hover:text-primary-hover">
                        Forgot password?
                    </a>
                </div>
                <button 
                    type="submit" 
                    class="w-full btn-primary py-2 px-4 rounded-lg font-medium"
                    aria-label="Log in to your account">
                    Log In
                </button>
            </form>
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-600">
                    Don't have an account? 
                    <a href="#" id="show-signup" class="text-primary hover:text-primary-hover font-medium">
                        Sign up
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Rest of your existing containers with improved accessibility and security -->
    <!-- ... -->

    <script>
        // Configuration
        const CONFIG = {
            API_BASE_URL: process.env.NODE_ENV === 'production' 
                ? 'https://api.patwa.toli/api/v1'
                : 'http://localhost:5000/api/v1',
            DEFAULT_AVATAR_PATH: '/uploads/profile-pics/default_avatar.png',
            DEFAULT_BUSINESS_IMAGE: '/uploads/businesses/default_business.png',
            MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
            ALLOWED_FILE_TYPES: {
                IMAGE: ['image/jpeg', 'image/png', 'image/gif'],
                VIDEO: ['video/mp4', 'video/webm'],
                DOCUMENT: ['application/pdf']
            },
            TOAST_DURATION: 5000,
            API_TIMEOUT: 30000,
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 1000,
            PASSWORD_MIN_LENGTH: 8
        };

        // Security Utilities
        const Security = {
            sanitizeInput(input) {
                return DOMPurify.sanitize(input, {
                    ALLOWED_TAGS: ['p', 'br', 'b', 'i', 'em', 'strong', 'a'],
                    ALLOWED_ATTR: ['href', 'target', 'rel']
                });
            },

            validateEmail(email) {
                return validator.isEmail(email);
            },

            validatePassword(password) {
                return validator.isStrongPassword(password, {
                    minLength: CONFIG.PASSWORD_MIN_LENGTH,
                    minLowercase: 1,
                    minUppercase: 1,
                    minNumbers: 1,
                    minSymbols: 1
                });
            },

            generateCsrfToken() {
                return Array.from(crypto.getRandomValues(new Uint8Array(32)))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }
        };

        // PatwaApp Class
        class PatwaApp {
            constructor() {
                this.state = {
                    activeTab: 'home',
                    currentUser: null,
                    isLoading: false,
                    posts: [],
                    stories: [],
                    events: [],
                    businesses: [],
                    suggestions: [],
                    csrfToken: Security.generateCsrfToken(),
                    lastSync: null
                };

                this.initializeApp();
            }

            async initializeApp() {
                try {
                    await this.registerServiceWorker();
                    this.initializeElements();
                    this.setupEventListeners();
                    await this.checkAuthState();
                    this.applyTheme(localStorage.getItem('theme') || 'light');
                } catch (error) {
                    this.showError('Failed to initialize app', error);
                }
            }

            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('ServiceWorker registered:', registration);
                    } catch (error) {
                        console.error('ServiceWorker registration failed:', error);
                    }
                }
            }

            initializeElements() {
                // Initialize all DOM elements with error handling
                try {
                    this.elements = {
                        loginForm: document.getElementById('login-form'),
                        signupForm: document.getElementById('signup-form'),
                        mainContent: document.getElementById('main-content'),
                        // ... rest of your elements
                    };

                    // Validate required elements
                    Object.entries(this.elements).forEach(([key, element]) => {
                        if (!element) {
                            throw new Error(`Required element "${key}" not found`);
                        }
                    });
                } catch (error) {
                    this.showError('Failed to initialize elements', error);
                }
            }

            setupEventListeners() {
                // Form submissions
                this.elements.loginForm?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });

                // Input validation
                const emailInput = document.getElementById('login-email');
                emailInput?.addEventListener('input', (e) => {
                    this.validateField(e.target, Security.validateEmail);
                });

                // Add more event listeners...
            }

            async handleLogin() {
                try {
                    const email = this.elements.loginForm.querySelector('#login-email').value;
                    const password = this.elements.loginForm.querySelector('#login-password').value;

                    // Validate input
                    if (!Security.validateEmail(email)) {
                        throw new Error('Invalid email format');
                    }

                    if (!Security.validatePassword(password)) {
                        throw new Error('Invalid password format');
                    }

                    // Show loading state
                    this.setLoading(true);

                    // Make API request
                    const response = await this.apiRequest('/auth/login', 'POST', {
                        email: Security.sanitizeInput(email),
                        password
                    });

                    // Handle success
                    if (response.success) {
                        this.state.currentUser = response.user;
                        this.navigateToHome();
                    }
                } catch (error) {
                    this.showError('Login failed', error);
                } finally {
                    this.setLoading(false);
                }
            }

            // API Request Helper
            async apiRequest(endpoint, method = 'GET', body = null) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);

                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': this.state.csrfToken,
                            // Add any auth headers here
                        },
                        body: body ? JSON.stringify(body) : null,
                        credentials: 'include',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Request failed');
                    }

                    return await response.json();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('Request timed out');
                    }
                    throw error;
                }
            }

            // UI Helpers
            showError(message, error = null) {
                console.error(message, error);
                this.showToast(message, 'error');
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                        <span>${Security.sanitizeInput(message)}</span>
                    </div>
                `;

                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), CONFIG.TOAST_DURATION);
            }

            setLoading(isLoading) {
                this.state.isLoading = isLoading;
                // Update UI loading state
            }

            // Theme Management
            applyTheme(theme) {
                document.body.className = `min-h-screen theme-${theme}`;
                localStorage.setItem('theme', theme);
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new PatwaApp();
        });
    </script>
</body>
</html>
