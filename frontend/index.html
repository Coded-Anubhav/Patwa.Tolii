<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patwa.Toli - Community Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --text-color: #111827;
            --secondary-text: #6b7280;
            --border-color: #e5e7eb;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --placeholder-color: #9ca3af;
        }

        .theme-dark {
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --bg-color: #1f2937;
            --card-bg: #111827;
            --text-color: #f9fafb;
            --secondary-text: #d1d5db;
            --border-color: #374151;
            --input-bg: #1f2937;
            --input-border: #4b5563;
            --placeholder-color: #9ca3af;
        }

        .theme-blue {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #eff6ff;
            --card-bg: #ffffff;
        }

        .theme-green {
            --primary: #059669;
            --primary-hover: #047857;
            --bg-color: #ecfdf5;
            --card-bg: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #6b73ff 0%, #000dff 100%);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background-color: rgba(var(--primary), 0.1);
        }

        .stories-scrollbar::-webkit-scrollbar {
            height: 4px;
        }

        .stories-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.2);
            border-radius: 2px;
        }

        .stories-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.4);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.3);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.5);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(107, 114, 128, 0.3) transparent;
        }

        .story-ring-unseen {
            border: 2px solid var(--primary);
            padding: 2px;
            border-radius: 50%;
        }

        .story-ring-seen {
            border: 2px solid var(--border-color);
            padding: 2px;
            border-radius: 50%;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 767px) {
            .main-content-area {
                padding-bottom: 80px;
            }
            
            .mobile-menu-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--card-bg);
                border-top: 1px solid var(--border-color);
                z-index: 40;
            }
        }
    </style>
</head>
<body class="min-h-screen theme-light">

    <!-- Login Container -->
    <div id="login-container" class="gradient-bg min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Patwa.Toli</h1>
                <p class="text-gray-600 mt-2">Connect with your community</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="remember-me" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">Remember me</label>
                    </div>
                    <a href="#" class="text-sm text-blue-600 hover:text-blue-500">Forgot password?</a>
                </div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-lg font-medium">Log In</button>
            </form>
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-600">Don't have an account? 
                    <a href="#" id="show-signup" class="text-blue-600 hover:text-blue-500 font-medium">Sign up</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Signup Container -->
    <div id="signup-container" class="gradient-bg min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Join Patwa.Toli</h1>
                <p class="text-gray-600 mt-2">Create your account</p>
            </div>
            <form id="signup-form" class="space-y-4">
                <div>
                    <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="signup-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="signup-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="signup-username" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signup-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="terms-agreement" required class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="terms-agreement" class="ml-2 block text-sm text-gray-700">I agree to the <a href="#" class="text-blue-600">Terms of Service</a> and <a href="#" class="text-blue-600">Privacy Policy</a></label>
                </div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-lg font-medium">Create Account</button>
            </form>
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-600">Already have an account? 
                    <a href="#" id="show-login" class="text-blue-600 hover:text-blue-500 font-medium">Log in</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Verification Pending Container -->
    <div id="verification-pending-container" class="gradient-bg min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md text-center">
            <div class="mb-6">
                <i class="fas fa-envelope-circle-check text-5xl text-blue-500 mb-4"></i>
                <h1 class="text-2xl font-bold text-gray-900">Verify Your Email</h1>
                <p class="text-gray-600 mt-2">We've sent a verification link to your email address. Please check your inbox and click the link to verify your account.</p>
            </div>
            <div class="mt-6">
                <p class="text-sm text-gray-600">Didn't receive the email? <a href="#" id="resend-verification" class="text-blue-600 hover:text-blue-500 font-medium">Resend verification</a></p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-30 border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-bold text-blue-600">Patwa.Toli</h1>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="flex-1 max-w-md mx-4">
                        <div class="relative">
                            <input type="text" placeholder="Search..." class="w-full px-4 py-2 border rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button class="absolute right-3 top-2 text-gray-500">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Main Navigation -->
                    <nav class="hidden md:flex space-x-8">
                        <a href="#" class="nav-link" data-tab="home">
                            <i class="fas fa-home text-xl"></i>
                        </a>
                        <a href="#" class="nav-link" data-tab="events">
                            <i class="fas fa-calendar-alt text-xl"></i>
                        </a>
                        <a href="#" class="nav-link" data-tab="businesses">
                            <i class="fas fa-store text-xl"></i>
                        </a>
                    </nav>
                    
                    <!-- User Menu -->
                    <div class="ml-4 flex items-center md:ml-6 relative">
                        <button id="create-post-btn" class="p-2 rounded-full hover:bg-gray-100">
                            <i class="fas fa-plus text-gray-600"></i>
                        </button>
                        
                        <button class="p-2 rounded-full hover:bg-gray-100 ml-1">
                            <i class="fas fa-bell text-gray-600"></i>
                        </button>
                        
                        <div class="ml-3 relative">
                            <div>
                                <button id="user-menu-button" class="flex items-center max-w-xs rounded-full focus:outline-none">
                                    <img id="header-profile-pic" class="h-8 w-8 rounded-full object-cover" src="/uploads/profile-pics/default_avatar.png" alt="Profile">
                                </button>
                            </div>
                            
                            <div id="user-menu-dropdown" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                                <div class="py-1">
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Your Profile</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                                    <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-6 pb-20 md:pb-6">
            <div class="grid grid-cols-12 gap-6">
                <!-- Left Sidebar -->
                <aside class="hidden md:block md:col-span-3 space-y-6 sticky top-[80px] h-[calc(100vh-100px)] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Profile Card -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <div class="flex items-center space-x-3">
                            <img id="sidebar-profile-pic" class="h-14 w-14 rounded-full object-cover" src="/uploads/profile-pics/default_avatar.png" alt="Profile">
                            <div>
                                <h3 id="sidebar-profile-name" class="font-semibold">Loading...</h3>
                                <p id="sidebar-profile-username" class="text-sm text-gray-500">@username</p>
                            </div>
                        </div>
                        <div class="flex justify-between mt-4 text-sm">
                            <a href="#" class="text-center">
                                <p id="sidebar-following-count" class="font-semibold">0</p>
                                <p class="text-gray-500">Following</p>
                            </a>
                            <a href="#" class="text-center">
                                <p id="sidebar-followers-count" class="font-semibold">0</p>
                                <p class="text-gray-500">Followers</p>
                            </a>
                            <a href="#" class="text-center">
                                <p id="sidebar-posts-count" class="font-semibold">0</p>
                                <p class="text-gray-500">Posts</p>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Create Buttons -->
                    <div class="bg-white rounded-xl shadow-sm p-3 border space-y-2">
                        <button id="create-story-sidebar-btn" class="w-full flex items-center justify-between px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-50">
                            <span>Create Story</span>
                            <i class="fas fa-plus-circle text-blue-500"></i>
                        </button>
                        <button id="create-event-sidebar-btn" class="w-full flex items-center justify-between px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-50">
                            <span>Create Event</span>
                            <i class="fas fa-plus-circle text-blue-500"></i>
                        </button>
                        <button id="create-business-sidebar-btn" class="w-full flex items-center justify-between px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-50">
                            <span>Add Business</span>
                            <i class="fas fa-plus-circle text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Stories -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <h3 class="font-semibold mb-3 flex items-center justify-between">
                            <span>Stories</span>
                            <a href="#" class="text-xs text-blue-500">See All</a>
                        </h3>
                        <div id="stories-container" class="flex space-x-4 overflow-x-auto pb-2 stories-scrollbar">
                            <!-- Stories will be loaded here -->
                            <div class="flex flex-col items-center space-y-1">
                                <div class="relative">
                                    <div class="story-ring-unseen rounded-full">
                                        <img src="/uploads/profile-pics/default_avatar.png" class="h-14 w-14 rounded-full object-cover" alt="Your Story">
                                    </div>
                                    <div class="absolute bottom-0 right-0 bg-blue-500 rounded-full p-1">
                                        <i class="fas fa-plus text-white text-xs"></i>
                                    </div>
                                </div>
                                <span class="text-xs">Your Story</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Events -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <h3 class="font-semibold mb-3 flex items-center justify-between">
                            <span>Upcoming Events</span>
                            <a href="#" class="text-xs text-blue-500">See All</a>
                        </h3>
                        <div id="events-sidebar-container" class="space-y-3">
                            <!-- Events will be loaded here -->
                            <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <div class="bg-blue-100 text-blue-600 rounded-lg p-2">
                                    <i class="fas fa-calendar-day"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium">Community Meetup</p>
                                    <p class="text-xs text-gray-500">Tomorrow • 6 PM</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Businesses -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <h3 class="font-semibold mb-3 flex items-center justify-between">
                            <span>Local Businesses</span>
                            <a href="#" class="text-xs text-blue-500">See All</a>
                        </h3>
                        <div id="businesses-sidebar-container" class="space-y-3">
                            <!-- Businesses will be loaded here -->
                            <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <img src="/uploads/businesses/default_business.png" class="h-10 w-10 rounded-lg object-cover" alt="Business">
                                <div>
                                    <p class="text-sm font-medium">Patwa Cafe</p>
                                    <p class="text-xs text-gray-500">Restaurant</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Main Feed Area -->
                <div class="col-span-12 md:col-span-6 space-y-6">
                    <!-- Create Post Box -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <div class="flex items-start space-x-3">
                            <img id="feed-profile-pic" src="/uploads/profile-pics/default_avatar.png" class="h-10 w-10 rounded-full object-cover" alt="Profile">
                            <div class="flex-1">
                                <button id="create-post-feed-btn" class="w-full text-left px-4 py-2 bg-gray-50 rounded-full hover:bg-gray-100 text-gray-500">
                                    What's on your mind?
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between mt-3 pt-3 border-t">
                            <button class="flex items-center justify-center flex-1 text-gray-500 hover:bg-gray-50 py-1 rounded-lg">
                                <i class="fas fa-image text-green-500 mr-2"></i>
                                <span class="text-sm font-medium">Photo</span>
                            </button>
                            <button class="flex items-center justify-center flex-1 text-gray-500 hover:bg-gray-50 py-1 rounded-lg">
                                <i class="fas fa-video text-red-500 mr-2"></i>
                                <span class="text-sm font-medium">Video</span>
                            </button>
                            <button class="flex items-center justify-center flex-1 text-gray-500 hover:bg-gray-50 py-1 rounded-lg">
                                <i class="fas fa-calendar text-blue-500 mr-2"></i>
                                <span class="text-sm font-medium">Event</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div id="main-content-area" class="space-y-6">
                        <div id="posts-container" class="space-y-6">
                            <!-- Posts will be loaded here -->
                            <div class="bg-white rounded-xl shadow-sm p-4 border">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex items-center space-x-3">
                                        <img src="/uploads/profile-pics/default_avatar.png" class="h-10 w-10 rounded-full object-cover" alt="User">
                                        <div>
                                            <h4 class="font-semibold">John Doe</h4>
                                            <p class="text-xs text-gray-500">2 hours ago</p>
                                        </div>
                                    </div>
                                    <button class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>
                                <p class="mb-3">Welcome to Patwa.Toli! This is a sample post to show how content will appear in your feed.</p>
                                <div class="mb-3">
                                    <img src="https://via.placeholder.com/600x400" class="w-full rounded-lg" alt="Post Image">
                                </div>
                                <div class="flex items-center justify-between text-sm text-gray-500 border-t border-b py-2 my-2">
                                    <button class="flex items-center space-x-1 hover:text-blue-500">
                                        <i class="far fa-thumbs-up"></i>
                                        <span>Like</span>
                                    </button>
                                    <button class="flex items-center space-x-1 hover:text-blue-500">
                                        <i class="far fa-comment"></i>
                                        <span>Comment</span>
                                    </button>
                                    <button class="flex items-center space-x-1 hover:text-blue-500">
                                        <i class="fas fa-share"></i>
                                        <span>Share</span>
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div class="flex items-center space-x-2">
                                        <img src="/uploads/profile-pics/default_avatar.png" class="h-8 w-8 rounded-full object-cover" alt="User">
                                        <div class="flex-1">
                                            <input type="text" placeholder="Write a comment..." class="w-full px-3 py-1 border rounded-full text-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="events-container-main" class="hidden space-y-4">
                            <!-- Events will be loaded here -->
                            <div class="bg-white rounded-xl shadow-sm p-4 border">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="bg-blue-100 text-blue-600 rounded-lg p-3">
                                            <i class="fas fa-calendar-day text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold">Community Meetup</h4>
                                            <p class="text-sm text-gray-500">Tomorrow • 6 PM • City Park</p>
                                        </div>
                                    </div>
                                    <button class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>
                                <p class="mb-3">Join us for our monthly community meetup at the city park. Bring your friends and family for food, games, and networking!</p>
                                <div class="mb-3">
                                    <img src="https://via.placeholder.com/600x300" class="w-full rounded-lg" alt="Event Image">
                                </div>
                                <button class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
                                    <i class="fas fa-calendar-plus mr-2"></i> RSVP
                                </button>
                            </div>
                        </div>
                        
                        <div id="businesses-container-main" class="hidden space-y-4">
                            <!-- Businesses will be loaded here -->
                            <div class="bg-white rounded-xl shadow-sm p-4 border">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center space-x-3">
                                        <img src="/uploads/businesses/default_business.png" class="h-14 w-14 rounded-lg object-cover" alt="Business">
                                        <div>
                                            <h4 class="font-semibold">Patwa Cafe</h4>
                                            <p class="text-sm text-gray-500">Restaurant • 4.5 ★ (24 reviews)</p>
                                            <p class="text-sm text-gray-500">123 Main St, City</p>
                                        </div>
                                    </div>
                                    <button class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>
                                <p class="mb-3">Serving authentic local cuisine with a modern twist. Open daily from 8 AM to 10 PM.</p>
                                <div class="mb-3">
                                    <img src="https://via.placeholder.com/600x300" class="w-full rounded-lg" alt="Business Image">
                                </div>
                                <div class="flex space-x-2">
                                    <button class="flex-1 btn-secondary py-1 rounded-lg text-sm font-medium">
                                        <i class="fas fa-phone-alt mr-1"></i> Call
                                    </button>
                                    <button class="flex-1 btn-secondary py-1 rounded-lg text-sm font-medium">
                                        <i class="fas fa-directions mr-1"></i> Directions
                                    </button>
                                    <button class="flex-1 btn-primary py-1 rounded-lg text-sm font-medium">
                                        <i class="fas fa-bookmark mr-1"></i> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="hidden flex justify-center py-8">
                        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
                    </div>
                    
                    <!-- End of Feed Message -->
                    <div id="end-of-feed" class="hidden text-center py-8 text-gray-500">
                        <p>You've reached the end of the feed</p>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <aside class="hidden md:block md:col-span-3 space-y-6 sticky top-[80px] h-[calc(100vh-100px)] overflow-y-auto pl-2 custom-scrollbar">
                    <!-- Suggestions -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <h3 class="font-semibold mb-3 flex items-center justify-between">
                            <span>People You May Know</span>
                            <a href="#" class="text-xs text-blue-500">See All</a>
                        </h3>
                        <div id="suggestions-container" class="space-y-3">
                            <!-- Suggestions will be loaded here -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <img src="/uploads/profile-pics/default_avatar.png" class="h-10 w-10 rounded-full object-cover" alt="User">
                                    <div>
                                        <p class="text-sm font-medium">Jane Smith</p>
                                        <p class="text-xs text-gray-500">12 mutual friends</p>
                                    </div>
                                </div>
                                <button class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <h3 class="font-semibold mb-3 flex items-center justify-between">
                            <span>Recent Activity</span>
                            <a href="#" class="text-xs text-blue-500">See All</a>
                        </h3>
                        <div id="activity-container" class="space-y-3">
                            <!-- Activity will be loaded here -->
                            <div class="flex items-start space-x-3">
                                <img src="/uploads/profile-pics/default_avatar.png" class="h-8 w-8 rounded-full object-cover" alt="User">
                                <div class="text-sm">
                                    <p><span class="font-medium">John Doe</span> liked your post</p>
                                    <p class="text-xs text-gray-500">2 hours ago</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border">
                        <h3 class="font-semibold mb-3">Appearance</h3>
                        <div class="space-y-2">
                            <button class="w-full flex items-center justify-between px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-50">
                                <span>Theme</span>
                                <div class="flex space-x-2">
                                    <button onclick="app.changeTheme('light')" class="h-5 w-5 rounded-full bg-gray-200 border-2 border-gray-300"></button>
                                    <button onclick="app.changeTheme('dark')" class="h-5 w-5 rounded-full bg-gray-800 border-2 border-gray-300"></button>
                                    <button onclick="app.changeTheme('blue')" class="h-5 w-5 rounded-full bg-blue-100 border-2 border-gray-300"></button>
                                    <button onclick="app.changeTheme('green')" class="h-5 w-5 rounded-full bg-green-100 border-2 border-gray-300"></button>
                                </div>
                            </button>
                            <button class="w-full flex items-center justify-between px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-50">
                                <span>Language</span>
                                <span class="text-gray-500">English</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="text-xs text-gray-500 px-2 py-4">
                        <div class="flex flex-wrap gap-2 mb-2">
                            <a href="#" class="hover:underline">About</a>
                            <a href="#" class="hover:underline">Help</a>
                            <a href="#" class="hover:underline">Terms</a>
                            <a href="#" class="hover:underline">Privacy</a>
                            <a href="#" class="hover:underline">Cookies</a>
                        </div>
                        <p>© 2023 Patwa.Toli</p>
                    </div>
                </aside>
            </div>
        </main>

        <!-- Mobile Navigation Bar -->
        <div id="mobile-menu-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center py-2 z-40">
            <a href="#" class="nav-link flex flex-col items-center text-gray-600" data-tab="home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="#" class="nav-link flex flex-col items-center text-gray-600" data-tab="events">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">Events</span>
            </a>
            <button id="mobile-create-post-btn" class="flex flex-col items-center text-gray-600">
                <i class="fas fa-plus-circle text-blue-500 text-2xl"></i>
            </button>
            <a href="#" class="nav-link flex flex-col items-center text-gray-600" data-tab="businesses">
                <i class="fas fa-store text-xl"></i>
                <span class="text-xs mt-1">Businesses</span>
            </a>
            <button class="flex flex-col items-center text-gray-600">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">Profile</span>
            </button>
        </div>
    </div>

    <!-- Admin Dashboard Placeholder -->
    <div id="admin-dashboard" class="hidden"></div>

    <!-- MODALS -->
    <!-- Create Post Modal -->
    <div id="create-post-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden px-4 fade-in">
        <div class="bg-white rounded-xl w-full max-w-lg shadow-xl">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="create-post-title" class="text-lg font-semibold">Create Post</h3>
                <button id="close-post-modal" class="text-2xl text-gray-500 hover:text-gray-700" aria-label="Close">×</button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <div class="flex items-center mb-4">
                    <img id="modal-user-pic" src="/uploads/profile-pics/default_avatar.png" class="h-10 w-10 rounded-full object-cover" alt="Profile">
                    <div class="ml-3">
                        <p id="modal-user-name" class="font-medium">User Name</p>
                        <select class="text-xs border rounded px-2 py-1 bg-gray-50">
                            <option>Public</option>
                            <option>Followers</option>
                            <option>Only Me</option>
                        </select>
                    </div>
                </div>
                <textarea id="post-content-input" rows="5" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="What's happening?"></textarea>
                <div id="post-media-preview" class="mt-2 max-h-48 overflow-hidden relative group hidden">
                    <button id="clear-media-preview-btn" class="absolute top-2 right-2 bg-gray-800 bg-opacity-70 text-white rounded-full h-8 w-8 flex items-center justify-center hover:bg-opacity-100 transition z-10">×</button>
                    <img id="media-preview-image" class="w-full rounded-lg hidden" alt="Media Preview">
                    <video id="media-preview-video" class="w-full rounded-lg hidden" controls></video>
                </div>
            </div>
            <div class="flex items-center justify-between border-t p-3 px-4 bg-gray-50 rounded-b-xl">
                <div class="flex space-x-2">
                    <input type="file" id="post-image-upload" class="hidden" accept="image/*">
                    <input type="file" id="post-video-upload" class="hidden" accept="video/*">
                    <button type="button" onclick="document.getElementById('post-image-upload').click()" class="text-gray-500 hover:text-green-500 p-2 rounded-full hover:bg-gray-100" title="Add image">
                        <i class="fas fa-image"></i>
                    </button>
                    <button type="button" onclick="document.getElementById('post-video-upload').click()" class="text-gray-500 hover:text-red-500 p-2 rounded-full hover:bg-gray-100" title="Add video">
                        <i class="fas fa-video"></i>
                    </button>
                    <button type="button" class="text-gray-500 hover:text-yellow-500 p-2 rounded-full hover:bg-gray-100" title="Add feeling">
                        <i class="far fa-smile"></i>
                    </button>
                    <button type="button" class="text-gray-500 hover:text-blue-500 p-2 rounded-full hover:bg-gray-100" title="Add location">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
                <button id="submit-post-btn" class="btn-primary px-6 py-2 text-sm font-medium rounded-lg">Post</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden px-4 fade-in">
        <div class="bg-white rounded-xl w-full max-w-md shadow-xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 class="text-lg font-semibold">Edit Profile</h3>
                <button id="close-edit-profile-modal" class="text-2xl text-gray-500 hover:text-gray-700" aria-label="Close">×</button>
            </div>
            <form id="edit-profile-form" class="p-4 space-y-4" enctype="multipart/form-data">
                <div class="flex flex-col items-center">
                    <div class="relative mb-3">
                        <img id="edit-profile-pic-preview" src="/uploads/profile-pics/default_avatar.png" class="h-24 w-24 rounded-full object-cover border-2 border-white shadow">
                        <button type="button" id="change-profile-pic-btn" class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 hover:bg-blue-600">
                            <i class="fas fa-camera"></i>
                        </button>
                        <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                    </div>
                    <button type="button" id="remove-profile-pic-btn" class="text-sm text-red-500 hover:text-red-700">Remove photo</button>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="edit-name" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="edit-username" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                    <textarea id="edit-bio" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="edit-location" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                    <input type="url" id="edit-website" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="w-full btn-primary py-2 rounded-lg font-medium">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Story Modal -->
    <div id="create-story-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden px-4 fade-in">
        <div class="bg-white rounded-xl w-full max-w-md shadow-xl">
            <form id="create-story-form" enctype="multipart/form-data">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-semibold">Create Story</h3>
                    <button type="button" id="close-story-modal" class="text-2xl text-gray-500 hover:text-gray-700" aria-label="Close">×</button>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Media</label>
                        <input type="file" name="storyMedia" required accept="image/*,video/*" class="w-full text-sm border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Caption</label>
                        <input type="text" name="caption" maxlength="200" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="p-3 border-t flex justify-end">
                    <button type="submit" class="btn-primary text-sm px-4 py-2 rounded-lg">Post Story</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="create-event-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden px-4 fade-in">
        <div class="bg-white rounded-xl w-full max-w-lg shadow-xl max-h-[90vh] flex flex-col">
            <form id="create-event-form" enctype="multipart/form-data" class="flex flex-col flex-grow">
                <div class="p-4 border-b flex-shrink-0 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Create Event</h3>
                    <button type="button" id="close-event-modal" class="text-2xl text-gray-500 hover:text-gray-700" aria-label="Close">×</button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto flex-grow">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" name="title" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea name="description" rows="3" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                        <input type="datetime-local" name="eventDate" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" name="location" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select name="category" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select a category</option>
                            <option value="meetup">Community Meetup</option>
                            <option value="concert">Concert</option>
                            <option value="workshop">Workshop</option>
                            <option value="sports">Sports</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Event Image</label>
                        <input type="file" name="eventImage" accept="image/*" class="w-full text-sm border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="p-3 border-t flex justify-end flex-shrink-0">
                    <button type="submit" class="btn-primary text-sm px-4 py-2 rounded-lg">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Business Modal -->
    <div id="create-business-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden px-4 fade-in">
        <div class="bg-white rounded-xl w-full max-w-lg shadow-xl max-h-[90vh] flex flex-col">
            <form id="create-business-form" enctype="multipart/form-data" class="flex flex-col flex-grow">
                <div class="p-4 border-b flex-shrink-0 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">List Business</h3>
                    <button type="button" id="close-business-modal" class="text-2xl text-gray-500 hover:text-gray-700" aria-label="Close">×</button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto flex-grow">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea name="description" rows="3" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select name="category" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select a category</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="retail">Retail</option>
                            <option value="service">Service</option>
                            <option value="health">Health & Wellness</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <input type="text" name="address" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" name="phone" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                            <input type="url" name="website" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" name="email" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Business Image</label>
                        <input type="file" name="businessImage" accept="image/*" class="w-full text-sm border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="p-3 border-t flex justify-end flex-shrink-0">
                    <button type="submit" class="btn-primary text-sm px-4 py-2 rounded-lg">Add Business</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Global Alert -->
    <div id="global-alert" class="fixed bottom-4 right-4 z-[100] hidden">
        <div class="p-4 rounded-lg shadow-lg bg-red-500 text-white">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="ml-3">
                    <p id="alert-message" class="text-sm font-medium">Sample alert message</p>
                </div>
                <div class="ml-4 pl-3">
                    <button id="close-alert" class="rounded-md focus:outline-none">
                        <span class="sr-only">Close</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = 'http://localhost:5000/api';
        const DEFAULT_AVATAR_PATH = '/uploads/profile-pics/default_avatar.png';
        const DEFAULT_BUSINESS_IMAGE = '/uploads/businesses/default_business.png';

        // --- PatwaApp Class Definition ---
        class PatwaApp {
            constructor() {
                this.state = {
                    activeTab: 'home',
                    currentUser: null,
                    isLoading: false,
                    posts: [],
                    stories: [],
                    events: [],
                    businesses: [],
                    suggestions: []
                };

                this.initElements();
                this.initEventListeners();
                this.checkAuthState();
                this.applyTheme(localStorage.getItem('selectedTheme') || 'light');
            }

            initElements() {
                // Auth containers
                this.loginContainer = document.getElementById('login-container');
                this.signupContainer = document.getElementById('signup-container');
                this.verificationContainer = document.getElementById('verification-pending-container');
                this.mainApp = document.getElementById('main-app');
                this.adminDashboard = document.getElementById('admin-dashboard');

                // Auth forms
                this.loginForm = document.getElementById('login-form');
                this.signupForm = document.getElementById('signup-form');
                this.resendVerificationBtn = document.getElementById('resend-verification');

                // Navigation
                this.navLinks = document.querySelectorAll('.nav-link');
                this.showLoginBtn = document.getElementById('show-login');
                this.showSignupBtn = document.getElementById('show-signup');
                this.logoutBtn = document.getElementById('logout-btn');
                this.userMenuButton = document.getElementById('user-menu-button');
                this.userMenuDropdown = document.getElementById('user-menu-dropdown');

                // Profile elements
                this.headerProfilePic = document.getElementById('header-profile-pic');
                this.sidebarProfilePic = document.getElementById('sidebar-profile-pic');
                this.feedProfilePic = document.getElementById('feed-profile-pic');
                this.sidebarProfileName = document.getElementById('sidebar-profile-name');
                this.sidebarProfileUsername = document.getElementById('sidebar-profile-username');
                this.sidebarFollowersCount = document.getElementById('sidebar-followers-count');
                this.sidebarFollowingCount = document.getElementById('sidebar-following-count');
                this.sidebarPostsCount = document.getElementById('sidebar-posts-count');

                // Content containers
                this.postsContainer = document.getElementById('posts-container');
                this.eventsContainerMain = document.getElementById('events-container-main');
                this.businessesContainerMain = document.getElementById('businesses-container-main');
                this.storiesContainer = document.getElementById('stories-container');
                this.eventsSidebarContainer = document.getElementById('events-sidebar-container');
                this.businessesSidebarContainer = document.getElementById('businesses-sidebar-container');
                this.suggestionsContainer = document.getElementById('suggestions-container');
                this.activityContainer = document.getElementById('activity-container');
                this.loadingSpinner = document.getElementById('loading-spinner');
                this.endOfFeed = document.getElementById('end-of-feed');

                // Create buttons
                this.createPostBtn = document.getElementById('create-post-btn');
                this.createPostFeedBtn = document.getElementById('create-post-feed-btn');
                this.mobileCreatePostBtn = document.getElementById('mobile-create-post-btn');
                this.createStorySidebarBtn = document.getElementById('create-story-sidebar-btn');
                this.createEventSidebarBtn = document.getElementById('create-event-sidebar-btn');
                this.createBusinessSidebarBtn = document.getElementById('create-business-sidebar-btn');

                // Modals
                this.createPostModal = document.getElementById('create-post-modal');
                this.closePostModalBtn = document.getElementById('close-post-modal');
                this.postContentInput = document.getElementById('post-content-input');
                this.postImageUpload = document.getElementById('post-image-upload');
                this.postVideoUpload = document.getElementById('post-video-upload');
                this.postMediaPreview = document.getElementById('post-media-preview');
                this.mediaPreviewImage = document.getElementById('media-preview-image');
                this.mediaPreviewVideo = document.getElementById('media-preview-video');
                this.clearMediaPreviewBtn = document.getElementById('clear-media-preview-btn');
                this.submitPostBtn = document.getElementById('submit-post-btn');

                this.editProfileModal = document.getElementById('edit-profile-modal');
                this.closeEditProfileModalBtn = document.getElementById('close-edit-profile-modal');
                this.editProfileForm = document.getElementById('edit-profile-form');
                this.editProfilePicPreview = document.getElementById('edit-profile-pic-preview');
                this.changeProfilePicBtn = document.getElementById('change-profile-pic-btn');
                this.profilePicUpload = document.getElementById('profile-pic-upload');
                this.removeProfilePicBtn = document.getElementById('remove-profile-pic-btn');
                this.editNameInput = document.getElementById('edit-name');
                this.editUsernameInput = document.getElementById('edit-username');
                this.editBioInput = document.getElementById('edit-bio');
                this.editLocationInput = document.getElementById('edit-location');
                this.editWebsiteInput = document.getElementById('edit-website');

                this.createStoryModal = document.getElementById('create-story-modal');
                this.closeStoryModalBtn = document.getElementById('close-story-modal');
                this.createStoryForm = document.getElementById('create-story-form');

                this.createEventModal = document.getElementById('create-event-modal');
                this.closeEventModalBtn = document.getElementById('close-event-modal');
                this.createEventForm = document.getElementById('create-event-form');

                this.createBusinessModal = document.getElementById('create-business-modal');
                this.closeBusinessModalBtn = document.getElementById('close-business-modal');
                this.createBusinessForm = document.getElementById('create-business-form');

                // Alert
                this.globalAlert = document.getElementById('global-alert');
                this.alertMessage = document.getElementById('alert-message');
                this.closeAlertBtn = document.getElementById('close-alert');
            }

            initEventListeners() {
                // Auth events
                this.loginForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                this.signupForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSignup();
                });

                this.showLoginBtn?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showLogin();
                });

                this.showSignupBtn?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showSignup();
                });

                this.logoutBtn?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleLogout();
                });

                this.resendVerificationBtn?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.resendVerification();
                });

                // Navigation events
                this.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabId = link.getAttribute('data-tab');
                        this.switchTab(tabId);
                    });
                });

                this.userMenuButton?.addEventListener('click', () => {
                    this.toggleUserMenu();
                });

                // Create post events
                this.createPostBtn?.addEventListener('click', () => {
                    this.showCreatePostModal();
                });

                this.createPostFeedBtn?.addEventListener('click', () => {
                    this.showCreatePostModal();
                });

                this.mobileCreatePostBtn?.addEventListener('click', () => {
                    this.showCreatePostModal();
                });

                this.closePostModalBtn?.addEventListener('click', () => {
                    this.hideCreatePostModal();
                });

                this.postImageUpload?.addEventListener('change', (e) => {
                    this.previewPostMedia(e, 'image');
                });

                this.postVideoUpload?.addEventListener('change', (e) => {
                    this.previewPostMedia(e, 'video');
                });

                this.clearMediaPreviewBtn?.addEventListener('click', () => {
                    this.clearPostMediaPreview();
                });

                this.submitPostBtn?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleCreatePost();
                });

                // Profile events
                this.closeEditProfileModalBtn?.addEventListener('click', () => {
                    this.hideEditProfileModal();
                });

                this.changeProfilePicBtn?.addEventListener('click', () => {
                    this.profilePicUpload.click();
                });

                this.profilePicUpload?.addEventListener('change', (e) => {
                    this.previewProfilePicUpload(e);
                });

                this.removeProfilePicBtn?.addEventListener('click', () => {
                    this.editProfilePicPreview.src = DEFAULT_AVATAR_PATH;
                });

                this.editProfileForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleEditProfile();
                });

                // Story events
                this.createStorySidebarBtn?.addEventListener('click', () => {
                    this.showCreateStoryModal();
                });

                this.closeStoryModalBtn?.addEventListener('click', () => {
                    this.hideCreateStoryModal();
                });

                this.createStoryForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleCreateStory();
                });

                // Event events
                this.createEventSidebarBtn?.addEventListener('click', () => {
                    this.showCreateEventModal();
                });

                this.closeEventModalBtn?.addEventListener('click', () => {
                    this.hideCreateEventModal();
                });

                this.createEventForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleCreateEvent();
                });

                // Business events
                this.createBusinessSidebarBtn?.addEventListener('click', () => {
                    this.showCreateBusinessModal();
                });

                this.closeBusinessModalBtn?.addEventListener('click', () => {
                    this.hideCreateBusinessModal();
                });

                this.createBusinessForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleCreateBusiness();
                });

                // Alert events
                this.closeAlertBtn?.addEventListener('click', () => {
                    this.globalAlert.classList.add('hidden');
                });

                // Window events
                window.addEventListener('scroll', this.debounce(() => {
                    this.handleScroll();
                }, 200));

                document.addEventListener('click', (e) => {
                    if (this.userMenuDropdown && !this.userMenuButton.contains(e.target) && !this.userMenuDropdown.contains(e.target)) {
                        this.userMenuDropdown.classList.add('hidden');
                    }
                });
            }

            // --- Core Functions ---
            async apiRequest(endpoint, method = 'GET', body = null, isFormData = false) {
                try {
                    const options = {
                        method,
                        headers: {},
                        credentials: 'include'
                    };

                    if (body) {
                        if (isFormData) {
                            options.body = body;
                        } else {
                            options.headers['Content-Type'] = 'application/json';
                            options.body = JSON.stringify(body);
                        }
                    }

                    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Request failed');
                    }

                    return await response.json();
                } catch (error) {
                    this.showAlert(error.message || 'Network error');
                    throw error;
                }
            }

            showAlert(message, type = 'error', duration = 5000) {
                if (!this.globalAlert || !this.alertMessage) return;

                // Set alert type styling
                let alertClass = 'bg-red-500';
                if (type === 'success') alertClass = 'bg-green-500';
                else if (type === 'info') alertClass = 'bg-blue-500';
                else if (type === 'warning') alertClass = 'bg-yellow-500';

                this.alertMessage.textContent = message;
                this.globalAlert.innerHTML = `
                    <div class="p-4 rounded-lg shadow-lg ${alertClass} text-white flex items-center">
                        <div class="flex-shrink-0 mr-3">
                            ${type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : ''}
                            ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : ''}
                            ${type === 'info' ? '<i class="fas fa-info-circle"></i>' : ''}
                            ${type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' : ''}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <div class="ml-4">
                            <button id="close-alert" class="rounded-md focus:outline-none">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                this.globalAlert.classList.remove('hidden');
                
                // Re-attach close event to the new button
                document.getElementById('close-alert')?.addEventListener('click', () => {
                    this.globalAlert.classList.add('hidden');
                });

                if (duration > 0) {
                    setTimeout(() => {
                        this.globalAlert.classList.add('hidden');
                    }, duration);
                }
            }

            async checkAuthState() {
                try {
                    const response = await this.apiRequest('/auth/check');
                    if (response.authenticated) {
                        this.state.currentUser = response.user;
                        this.showMainApp();
                    } else {
                        this.showLogin();
                    }
                } catch (error) {
                    this.showLogin();
                }
            }

            async fetchUserProfile() {
                try {
                    const response = await this.apiRequest('/users/me');
                    this.state.currentUser = response;
                    this.updateUserProfileUI();
                    return response;
                } catch (error) {
                    this.showAlert('Failed to load profile: ' + error.message);
                }
            }

            async handleLogin() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const rememberMe = document.getElementById('remember-me').checked;

                try {
                    const response = await this.apiRequest('/auth/login', 'POST', {
                        email,
                        password,
                        rememberMe
                    });

                    if (response.verified) {
                        this.state.currentUser = response.user;
                        this.showMainApp();
                    } else {
                        this.showVerificationPending();
                    }
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleSignup() {
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const username = document.getElementById('signup-username').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;

                if (password !== confirmPassword) {
                    this.showAlert("Passwords don't match");
                    return;
                }

                try {
                    await this.apiRequest('/auth/signup', 'POST', {
                        name,
                        email,
                        username,
                        password
                    });

                    this.showVerificationPending();
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async resendVerification() {
                try {
                    await this.apiRequest('/auth/resend-verification', 'POST');
                    this.showAlert('Verification email resent', 'success');
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            handleLogout() {
                this.apiRequest('/auth/logout', 'POST')
                    .then(() => {
                        this.state.currentUser = null;
                        this.showLogin();
                    })
                    .catch(error => {
                        this.showAlert(error.message);
                    });
            }

            updateUserProfileUI() {
                if (!this.state.currentUser) return;

                const user = this.state.currentUser;
                const profilePic = this.getSafeMediaUrl(user.profilePic);

                // Update profile pictures
                if (this.headerProfilePic) this.headerProfilePic.src = profilePic;
                if (this.sidebarProfilePic) this.sidebarProfilePic.src = profilePic;
                if (this.feedProfilePic) this.feedProfilePic.src = profilePic;
                if (this.modalUserPic) this.modalUserPic.src = profilePic;

                // Update names and usernames
                if (this.sidebarProfileName) this.sidebarProfileName.textContent = user.name;
                if (this.sidebarProfileUsername) this.sidebarProfileUsername.textContent = `@${user.username}`;
                if (this.modalUserName) this.modalUserName.textContent = user.name;

                // Update counts
                if (this.sidebarFollowersCount) this.sidebarFollowersCount.textContent = user.followersCount || 0;
                if (this.sidebarFollowingCount) this.sidebarFollowingCount.textContent = user.followingCount || 0;
                if (this.sidebarPostsCount) this.sidebarPostsCount.textContent = user.postsCount || 0;

                // Update edit profile modal
                if (this.editProfilePicPreview) this.editProfilePicPreview.src = profilePic;
                if (this.editNameInput) this.editNameInput.value = user.name || '';
                if (this.editUsernameInput) this.editUsernameInput.value = user.username || '';
                if (this.editBioInput) this.editBioInput.value = user.bio || '';
                if (this.editLocationInput) this.editLocationInput.value = user.location || '';
                if (this.editWebsiteInput) this.editWebsiteInput.value = user.website || '';
            }

            // --- Content Loading & Rendering ---
            async loadPosts() {
                try {
                    this.loadingSpinner?.classList.remove('hidden');
                    const response = await this.apiRequest('/posts/feed');
                    this.state.posts = response;
                    this.renderPosts(response);
                    this.loadingSpinner?.classList.add('hidden');
                } catch (error) {
                    this.showAlert('Failed to load posts: ' + error.message);
                    this.loadingSpinner?.classList.add('hidden');
                }
            }

            renderPosts(postsToRender, prepend = false) {
                if (prepend) {
                    this.state.posts = [...postsToRender, ...this.state.posts];
                } else {
                    this.state.posts = [...this.state.posts, ...postsToRender];
                }

                const postsHTML = this.state.posts.map(post => this.createPostHtml(post)).join('');
                if (this.postsContainer) {
                    this.postsContainer.innerHTML = postsHTML;
                    
                    // Re-attach event listeners to new post elements
                    document.querySelectorAll('.like-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const postId = e.currentTarget.getAttribute('data-post-id');
                            this.handleLikeToggle(postId, e.currentTarget);
                        });
                    });
                    
                    document.querySelectorAll('.comment-form').forEach(form => {
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const postId = e.currentTarget.getAttribute('data-post-id');
                            this.handleAddComment(e, postId);
                        });
                    });
                }
            }

            createPostHtml(post) {
                const userPic = this.getSafeMediaUrl(post.user.profilePic);
                const mediaHtml = post.image 
                    ? `<img src="${this.getSafeMediaUrl(post.image)}" class="w-full rounded-lg mb-3" alt="Post image">`
                    : post.video 
                    ? `<video src="${this.getSafeMediaUrl(post.video)}" class="w-full rounded-lg mb-3" controls></video>`
                    : '';

                const likeBtnClass = post.isLiked ? 'text-blue-500' : 'text-gray-500';
                const likeIcon = post.isLiked ? 'fas fa-thumbs-up' : 'far fa-thumbs-up';

                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 border post-${post._id}">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center space-x-3">
                                <img src="${userPic}" class="h-10 w-10 rounded-full object-cover" alt="${post.user.name}">
                                <div>
                                    <h4 class="font-semibold">${post.user.name}</h4>
                                    <p class="text-xs text-gray-500">${this.formatDate(post.createdAt)}</p>
                                </div>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                        <p class="mb-3">${this.linkify(post.content)}</p>
                        ${mediaHtml}
                        <div class="flex items-center justify-between text-sm text-gray-500 border-t border-b py-2 my-2">
                            <button class="like-btn flex items-center space-x-1 ${likeBtnClass} hover:text-blue-500" data-post-id="${post._id}">
                                <i class="${likeIcon}"></i>
                                <span>Like (${post.likesCount})</span>
                            </button>
                            <button class="flex items-center space-x-1 hover:text-blue-500">
                                <i class="far fa-comment"></i>
                                <span>Comment (${post.commentsCount})</span>
                            </button>
                            <button class="flex items-center space-x-1 hover:text-blue-500">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                        </div>
                        <div class="mt-3">
                            <form class="comment-form flex items-center space-x-2" data-post-id="${post._id}">
                                <img src="${this.getSafeMediaUrl(this.state.currentUser?.profilePic)}" class="h-8 w-8 rounded-full object-cover" alt="Your profile">
                                <div class="flex-1">
                                    <input type="text" placeholder="Write a comment..." class="w-full px-3 py-1 border rounded-full text-sm comment-input">
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            async loadStories() {
                try {
                    const response = await this.apiRequest('/stories/feed');
                    this.state.stories = response;
                    this.renderStories(response);
                } catch (error) {
                    this.showAlert('Failed to load stories: ' + error.message);
                }
            }

            renderStories(storyFeed) {
                if (!this.storiesContainer) return;

                let storiesHTML = `
                    <div class="flex flex-col items-center space-y-1">
                        <div class="relative">
                            <div class="story-ring-unseen rounded-full">
                                <img src="${this.getSafeMediaUrl(this.state.currentUser?.profilePic)}" class="h-14 w-14 rounded-full object-cover" alt="Your Story">
                            </div>
                            <div class="absolute bottom-0 right-0 bg-blue-500 rounded-full p-1">
                                <i class="fas fa-plus text-white text-xs"></i>
                            </div>
                        </div>
                        <span class="text-xs">Your Story</span>
                    </div>
                `;

                storyFeed.forEach(story => {
                    const userPic = this.getSafeMediaUrl(story.user.profilePic);
                    const ringClass = story.seen ? 'story-ring-seen' : 'story-ring-unseen';
                    
                    storiesHTML += `
                        <div class="flex flex-col items-center space-y-1" onclick="app.viewUserStories('${story.user._id}')">
                            <div class="${ringClass} rounded-full">
                                <img src="${userPic}" class="h-14 w-14 rounded-full object-cover" alt="${story.user.name}">
                            </div>
                            <span class="text-xs">${story.user.username}</span>
                        </div>
                    `;
                });

                this.storiesContainer.innerHTML = storiesHTML;
            }

            async loadEvents(sidebar = false) {
                try {
                    const response = await this.apiRequest('/events');
                    this.state.events = response;
                    
                    if (sidebar) {
                        this.renderEventsSidebar(response);
                    } else {
                        this.renderEventsMain(response);
                    }
                } catch (error) {
                    this.showAlert('Failed to load events: ' + error.message);
                }
            }

            renderEventsSidebar(events) {
                if (!this.eventsSidebarContainer) return;

                let eventsHTML = '';
                events.slice(0, 5).forEach(event => {
                    eventsHTML += `
                        <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="app.viewEventDetails('${event._id}')">
                            <div class="bg-blue-100 text-blue-600 rounded-lg p-2">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">${event.title}</p>
                                <p class="text-xs text-gray-500">${this.formatDate(event.eventDate)}</p>
                            </div>
                        </div>
                    `;
                });

                this.eventsSidebarContainer.innerHTML = eventsHTML;
            }

            renderEventsMain(events) {
                if (!this.eventsContainerMain) return;

                let eventsHTML = '';
                events.forEach(event => {
                    const eventImage = event.image 
                        ? `<img src="${this.getSafeMediaUrl(event.image)}" class="w-full rounded-lg mb-3" alt="Event image">`
                        : '';

                    eventsHTML += `
                        <div class="bg-white rounded-xl shadow-sm p-4 border">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="bg-blue-100 text-blue-600 rounded-lg p-3">
                                        <i class="fas fa-calendar-day text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold">${event.title}</h4>
                                        <p class="text-sm text-gray-500">${this.formatDate(event.eventDate)} • ${event.location}</p>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                            <p class="mb-3">${event.description}</p>
                            ${eventImage}
                            <button class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
                                <i class="fas fa-calendar-plus mr-2"></i> RSVP
                            </button>
                        </div>
                    `;
                });

                this.eventsContainerMain.innerHTML = eventsHTML;
            }

            async loadBusinesses(sidebar = false) {
                try {
                    const response = await this.apiRequest('/businesses');
                    this.state.businesses = response;
                    
                    if (sidebar) {
                        this.renderBusinessesSidebar(response);
                    } else {
                        this.renderBusinessesMain(response);
                    }
                } catch (error) {
                    this.showAlert('Failed to load businesses: ' + error.message);
                }
            }

            renderBusinessesSidebar(businesses) {
                if (!this.businessesSidebarContainer) return;

                let businessesHTML = '';
                businesses.slice(0, 5).forEach(business => {
                    const bizImage = this.getSafeMediaUrl(business.image, DEFAULT_BUSINESS_IMAGE);
                    
                    businessesHTML += `
                        <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="app.viewBusinessDetails('${business._id}')">
                            <img src="${bizImage}" class="h-10 w-10 rounded-lg object-cover" alt="${business.name}">
                            <div>
                                <p class="text-sm font-medium">${business.name}</p>
                                <p class="text-xs text-gray-500">${business.category}</p>
                            </div>
                        </div>
                    `;
                });

                this.businessesSidebarContainer.innerHTML = businessesHTML;
            }

            renderBusinessesMain(businesses) {
                if (!this.businessesContainerMain) return;

                let businessesHTML = '';
                businesses.forEach(business => {
                    const bizImage = this.getSafeMediaUrl(business.image, DEFAULT_BUSINESS_IMAGE);
                    
                    businessesHTML += `
                        <div class="bg-white rounded-xl shadow-sm p-4 border">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <img src="${bizImage}" class="h-14 w-14 rounded-lg object-cover" alt="${business.name}">
                                    <div>
                                        <h4 class="font-semibold">${business.name}</h4>
                                        <p class="text-sm text-gray-500">${business.category} • ${business.rating || '0'} ★ (${business.reviewsCount || '0'} reviews)</p>
                                        <p class="text-sm text-gray-500">${business.address}</p>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                            <p class="mb-3">${business.description}</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 btn-secondary py-1 rounded-lg text-sm font-medium">
                                    <i class="fas fa-phone-alt mr-1"></i> Call
                                </button>
                                <button class="flex-1 btn-secondary py-1 rounded-lg text-sm font-medium">
                                    <i class="fas fa-directions mr-1"></i> Directions
                                </button>
                                <button class="flex-1 btn-primary py-1 rounded-lg text-sm font-medium">
                                    <i class="fas fa-bookmark mr-1"></i> Save
                                </button>
                            </div>
                        </div>
                    `;
                });

                this.businessesContainerMain.innerHTML = businessesHTML;
            }

            async loadSuggestions() {
                try {
                    const response = await this.apiRequest('/users/suggestions');
                    this.state.suggestions = response;
                    this.renderSuggestions(response);
                } catch (error) {
                    this.showAlert('Failed to load suggestions: ' + error.message);
                }
            }

            renderSuggestions(suggestions) {
                if (!this.suggestionsContainer) return;

                let suggestionsHTML = '';
                suggestions.forEach(user => {
                    const userPic = this.getSafeMediaUrl(user.profilePic);
                    
                    suggestionsHTML += `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img src="${userPic}" class="h-10 w-10 rounded-full object-cover" alt="${user.name}">
                                <div>
                                    <p class="text-sm font-medium">${user.name}</p>
                                    <p class="text-xs text-gray-500">${user.mutualFriends} mutual friends</p>
                                </div>
                            </div>
                            <button class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg" onclick="app.handleFollowToggleSuggestion('${user._id}', this)">
                                Add
                            </button>
                        </div>
                    `;
                });

                this.suggestionsContainer.innerHTML = suggestionsHTML;
            }

            // --- View Functions ---
            viewStory(storyId) {
                this.showAlert(`Story UI TBD: ${storyId}`, 'info');
            }

            viewUserStories(userId) {
                this.showAlert(`Story UI TBD for User: ${userId}`, 'info');
            }

            viewEventDetails(eventId) {
                this.showAlert(`Event Detail UI TBD: ${eventId}`, 'info');
            }

            viewBusinessDetails(bizId) {
                this.showAlert(`Business Detail UI TBD: ${bizId}`, 'info');
            }

            // --- UI State Management ---
            _updateUIState(state) {
                this.loginContainer?.classList.add('hidden');
                this.signupContainer?.classList.add('hidden');
                this.verificationContainer?.classList.add('hidden');
                this.mainApp?.classList.add('hidden');
                this.adminDashboard?.classList.add('hidden');

                switch (state) {
                    case 'login':
                        this.loginContainer?.classList.remove('hidden');
                        break;
                    case 'signup':
                        this.signupContainer?.classList.remove('hidden');
                        break;
                    case 'verification':
                        this.verificationContainer?.classList.remove('hidden');
                        break;
                    case 'main':
                        this.mainApp?.classList.remove('hidden');
                        this.loadInitialContent();
                        break;
                    case 'admin':
                        this.adminDashboard?.classList.remove('hidden');
                        break;
                }
            }

            showLogin() {
                this._updateUIState('login');
            }

            showSignup() {
                this._updateUIState('signup');
            }

            showVerificationPending() {
                this._updateUIState('verification');
            }

            showMainApp() {
                this._updateUIState('main');
                this.fetchUserProfile();
            }

            loadInitialContent() {
                this.loadPosts();
                this.loadStories();
                this.loadEvents(true);
                this.loadBusinesses(true);
                this.loadSuggestions();
            }

            // --- Modal Functions ---
            showCreatePostModal() {
                if (!this.createPostModal) return;
                
                this.createPostModal.classList.remove('hidden');
                this.postContentInput.value = '';
                this.postMediaPreview.classList.add('hidden');
                this.mediaPreviewImage.classList.add('hidden');
                this.mediaPreviewVideo.classList.add('hidden');
                this.postImageUpload.value = '';
                this.postVideoUpload.value = '';
                
                if (this.state.currentUser) {
                    this.modalUserPic.src = this.getSafeMediaUrl(this.state.currentUser.profilePic);
                    this.modalUserName.textContent = this.state.currentUser.name;
                }
            }

            hideCreatePostModal() {
                this.createPostModal?.classList.add('hidden');
            }

            showEditProfileModal() {
                if (!this.editProfileModal) return;
                
                this.editProfileModal.classList.remove('hidden');
                
                if (this.state.currentUser) {
                    this.editProfilePicPreview.src = this.getSafeMediaUrl(this.state.currentUser.profilePic);
                    this.editNameInput.value = this.state.currentUser.name || '';
                    this.editUsernameInput.value = this.state.currentUser.username || '';
                    this.editBioInput.value = this.state.currentUser.bio || '';
                    this.editLocationInput.value = this.state.currentUser.location || '';
                    this.editWebsiteInput.value = this.state.currentUser.website || '';
                }
            }

            hideEditProfileModal() {
                this.editProfileModal?.classList.add('hidden');
            }

// --- Story, Event, Business Creation ---
            showCreateStoryModal() {
                if (!this.createStoryModal) return;
                this.createStoryModal.classList.remove('hidden');
                this.createStoryForm.reset();
            }

            hideCreateStoryModal() {
                this.createStoryModal?.classList.add('hidden');
            }

            showCreateEventModal() {
                if (!this.createEventModal) return;
                this.createEventModal.classList.remove('hidden');
                this.createEventForm.reset();
                
                // Set default datetime to now + 1 hour
                const now = new Date();
                now.setHours(now.getHours() + 1);
                const datetimeLocal = now.toISOString().slice(0, 16);
                document.querySelector('#create-event-form input[type="datetime-local"]').value = datetimeLocal;
            }

            hideCreateEventModal() {
                this.createEventModal?.classList.add('hidden');
            }

            showCreateBusinessModal() {
                if (!this.createBusinessModal) return;
                this.createBusinessModal.classList.remove('hidden');
                this.createBusinessForm.reset();
            }

            hideCreateBusinessModal() {
                this.createBusinessModal?.classList.add('hidden');
            }

            // --- Media Handling ---
            previewProfilePicUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.editProfilePicPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            previewPostMedia(event, type) {
                const file = event.target.files[0];
                if (!file) return;

                // Clear previous preview
                this.clearPostMediaPreview();

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.postMediaPreview.classList.remove('hidden');
                    
                    if (type === 'image') {
                        this.mediaPreviewImage.src = e.target.result;
                        this.mediaPreviewImage.classList.remove('hidden');
                    } else if (type === 'video') {
                        this.mediaPreviewVideo.src = e.target.result;
                        this.mediaPreviewVideo.classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(file);
            }

            clearPostMediaPreview() {
                this.postMediaPreview.classList.add('hidden');
                this.mediaPreviewImage.classList.add('hidden');
                this.mediaPreviewVideo.classList.add('hidden');
                this.postImageUpload.value = '';
                this.postVideoUpload.value = '';
            }

            // --- Create Content Handlers ---
            async handleCreateStory() {
                try {
                    const formData = new FormData(this.createStoryForm);
                    
                    // Additional validation
                    const mediaFile = formData.get('storyMedia');
                    if (!mediaFile || mediaFile.size === 0) {
                        throw new Error('Please select a media file');
                    }

                    const response = await this.apiRequest('/stories', 'POST', formData, true);
                    this.showAlert('Story posted successfully!', 'success');
                    this.hideCreateStoryModal();
                    this.loadStories();
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleCreateEvent() {
                try {
                    const formData = new FormData(this.createEventForm);
                    
                    // Validate required fields
                    const title = formData.get('title');
                    const description = formData.get('description');
                    const eventDate = formData.get('eventDate');
                    const location = formData.get('location');
                    
                    if (!title || !description || !eventDate || !location) {
                        throw new Error('Please fill all required fields');
                    }

                    const response = await this.apiRequest('/events', 'POST', formData, true);
                    this.showAlert('Event created successfully!', 'success');
                    this.hideCreateEventModal();
                    this.loadEvents(this.state.activeTab === 'events');
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleCreateBusiness() {
                try {
                    const formData = new FormData(this.createBusinessForm);
                    
                    // Validate required fields
                    const name = formData.get('name');
                    const description = formData.get('description');
                    const category = formData.get('category');
                    const address = formData.get('address');
                    
                    if (!name || !description || !category || !address) {
                        throw new Error('Please fill all required fields');
                    }

                    const response = await this.apiRequest('/businesses', 'POST', formData, true);
                    this.showAlert('Business added successfully!', 'success');
                    this.hideCreateBusinessModal();
                    this.loadBusinesses(this.state.activeTab === 'businesses');
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleCreatePost() {
                try {
                    const content = this.postContentInput.value.trim();
                    if (!content && !this.postImageUpload.files[0] && !this.postVideoUpload.files[0]) {
                        throw new Error('Please add some content or media');
                    }

                    const formData = new FormData();
                    formData.append('content', content);
                    
                    // Add privacy setting if implemented
                    const privacy = document.querySelector('#create-post-modal select')?.value || 'public';
                    formData.append('privacy', privacy);

                    // Add media if present
                    if (this.postImageUpload.files[0]) {
                        formData.append('media', this.postImageUpload.files[0]);
                    } else if (this.postVideoUpload.files[0]) {
                        formData.append('media', this.postVideoUpload.files[0]);
                    }

                    const response = await this.apiRequest('/posts', 'POST', formData, true);
                    this.showAlert('Post created successfully!', 'success');
                    this.renderPosts([response], true); // Prepend new post
                    this.hideCreatePostModal();
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleEditProfile() {
                try {
                    const formData = new FormData(this.editProfileForm);
                    
                    // Add all editable fields
                    formData.append('name', this.editNameInput.value);
                    formData.append('username', this.editUsernameInput.value);
                    formData.append('bio', this.editBioInput.value);
                    formData.append('location', this.editLocationInput.value);
                    formData.append('website', this.editWebsiteInput.value);

                    // Add profile picture if changed
                    if (this.profilePicUpload.files[0]) {
                        formData.append('profilePic', this.profilePicUpload.files[0]);
                    } else if (this.editProfilePicPreview.src.includes('data:image')) {
                        // If a new image was previewed but not saved yet
                        const blob = await fetch(this.editProfilePicPreview.src).then(r => r.blob());
                        formData.append('profilePic', blob, 'profile.jpg');
                    }

                    const response = await this.apiRequest('/users/me', 'PATCH', formData, true);
                    this.state.currentUser = response;
                    this.updateUserProfileUI();
                    this.showAlert('Profile updated successfully!', 'success');
                    this.hideEditProfileModal();
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            // --- Interaction Handlers ---
            async handleLikeToggle(postId, buttonElement) {
                try {
                    const response = await this.apiRequest(`/posts/${postId}/like`, 'POST');
                    
                    // Update UI immediately
                    const icon = buttonElement.querySelector('i');
                    const countSpan = buttonElement.querySelector('span');
                    
                    if (response.action === 'liked') {
                        icon.classList.replace('far', 'fas');
                        buttonElement.classList.add('text-blue-500');
                    } else {
                        icon.classList.replace('fas', 'far');
                        buttonElement.classList.remove('text-blue-500');
                    }
                    
                    // Update count
                    const countText = countSpan.textContent.match(/\((\d+)\)/);
                    if (countText) {
                        const currentCount = parseInt(countText[1]);
                        const newCount = response.action === 'liked' ? currentCount + 1 : currentCount - 1;
                        countSpan.textContent = countSpan.textContent.replace(/\(\d+\)/, `(${newCount})`);
                    }
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleAddComment(event, postId) {
                try {
                    const commentInput = event.target.querySelector('.comment-input');
                    const commentText = commentInput.value.trim();
                    
                    if (!commentText) {
                        throw new Error('Comment cannot be empty');
                    }

                    const response = await this.apiRequest(`/posts/${postId}/comments`, 'POST', {
                        content: commentText
                    });

                    // Update UI
                    const commentsCount = event.target.closest('.post').querySelector('.fa-comment').nextElementSibling;
                    if (commentsCount) {
                        const countMatch = commentsCount.textContent.match(/\((\d+)\)/);
                        if (countMatch) {
                            const currentCount = parseInt(countMatch[1]);
                            commentsCount.textContent = commentsCount.textContent.replace(/\(\d+\)/, `(${currentCount + 1})`);
                        }
                    }

                    commentInput.value = '';
                    this.showAlert('Comment added!', 'success');
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleFollowToggleFromMenu(userIdToToggle, linkElement) {
                try {
                    const response = await this.toggleFollowUser(userIdToToggle);
                    
                    // Update UI
                    if (linkElement) {
                        if (response.action === 'followed') {
                            linkElement.textContent = 'Unfollow';
                        } else {
                            linkElement.textContent = 'Follow';
                        }
                    }
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async handleFollowToggleSuggestion(userIdToFollow, buttonElement) {
                try {
                    const response = await this.toggleFollowUser(userIdToFollow);
                    
                    // Update UI
                    if (buttonElement) {
                        if (response.action === 'followed') {
                            buttonElement.textContent = 'Following';
                            buttonElement.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                            buttonElement.classList.add('bg-blue-100', 'text-blue-600');
                        } else {
                            buttonElement.textContent = 'Add';
                            buttonElement.classList.remove('bg-blue-100', 'text-blue-600');
                            buttonElement.classList.add('bg-gray-100', 'hover:bg-gray-200');
                        }
                    }
                    
                    this.showAlert(response.action === 'followed' ? 'User followed!' : 'User unfollowed', 'success');
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            async toggleFollowUser(userIdToToggle) {
                try {
                    return await this.apiRequest(`/users/${userIdToToggle}/toggle-follow`, 'POST');
                } catch (error) {
                    throw error;
                }
            }

            async handleDeletePost(postId, element) {
                try {
                    if (!confirm('Are you sure you want to delete this post?')) return;
                    
                    await this.apiRequest(`/posts/${postId}`, 'DELETE');
                    element.closest(`.post-${postId}`).remove();
                    this.showAlert('Post deleted', 'success');
                } catch (error) {
                    this.showAlert(error.message);
                }
            }

            // --- Utility Functions ---
            getSafeMediaUrl(url, fallback = null) {
                if (!url) return fallback || DEFAULT_AVATAR_PATH;
                
                // Only allow http/https URLs or relative paths
                if (typeof url === 'string') {
                    if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) {
                        return url;
                    }
                }
                
                return fallback || DEFAULT_AVATAR_PATH;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) return 'Just now';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
                
                // For dates more than 1 day ago
                const options = { month: 'short', day: 'numeric' };
                if (date.getFullYear() !== now.getFullYear()) {
                    options.year = 'numeric';
                }
                return date.toLocaleDateString('en-US', options);
            }

            linkify(text) {
                if (!text) return '';
                
                // Basic XSS protection
                text = text.toString()
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                // Linkify URLs
                text = text.replace(
                    /(https?:\/\/[^\s]+)/g, 
                    '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">$1</a>'
                );
                
                // Linkify @mentions
                text = text.replace(
                    /@([\w-]+)/g, 
                    '<a href="/$1" class="text-blue-500 hover:underline">@$1</a>'
                );
                
                // Linkify #hashtags
                text = text.replace(
                    /#(\w+)/g, 
                    '<a href="/hashtag/$1" class="text-blue-500 hover:underline">#$1</a>'
                );
                
                return text;
            }

            navigateToUserProfile(username) {
                // In a real SPA, this would use your router
                window.location.href = `/profile/${username}`;
            }

            searchHashtag(hashtag) {
                // In a real SPA, this would use your router
                window.location.href = `/hashtag/${hashtag.replace('#', '')}`;
            }

            applyTheme(themeName) {
                document.documentElement.className = ''; // Clear existing
                document.documentElement.classList.add(`theme-${themeName}`);
                localStorage.setItem('selectedTheme', themeName);
            }

            changeTheme(themeName) {
                this.applyTheme(themeName);
                this.showAlert(`Theme changed to ${themeName}`, 'success');
            }

            handleScroll() {
                if (this.isLoading) return;
                
                const scrollPosition = window.innerHeight + window.scrollY;
                const pageHeight = document.body.offsetHeight;
                const threshold = 500; // pixels from bottom
                
                if (pageHeight - scrollPosition < threshold) {
                    this.loadMoreContent();
                }
            }

            async loadMoreContent() {
                if (this.isLoading) return;
                this.isLoading = true;
                
                try {
                    switch (this.state.activeTab) {
                        case 'home':
                            await this.loadMorePosts();
                            break;
                        case 'events':
                            await this.loadMoreEvents();
                            break;
                        case 'businesses':
                            await this.loadMoreBusinesses();
                            break;
                    }
                } catch (error) {
                    this.showAlert(error.message);
                } finally {
                    this.isLoading = false;
                }
            }

            async loadMorePosts() {
                if (!this.state.posts.length) return;
                
                const lastPostId = this.state.posts[this.state.posts.length - 1]._id;
                const response = await this.apiRequest(`/posts/feed?before=${lastPostId}`);
                
                if (response.length) {
                    this.renderPosts(response);
                } else {
                    this.endOfFeed?.classList.remove('hidden');
                }
            }

            async loadMoreEvents() {
                if (!this.state.events.length) return;
                
                // Implementation would depend on your pagination strategy
                // This is just a placeholder
                const response = await this.apiRequest('/events?page=2');
                if (response.length) {
                    this.renderEventsMain(response);
                } else {
                    this.endOfFeed?.classList.remove('hidden');
                }
            }

            async loadMoreBusinesses() {
                if (!this.state.businesses.length) return;
                
                // Implementation would depend on your pagination strategy
                // This is just a placeholder
                const response = await this.apiRequest('/businesses?page=2');
                if (response.length) {
                    this.renderBusinessesMain(response);
                } else {
                    this.endOfFeed?.classList.remove('hidden');
                }
            }

            debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(context, args);
                    }, wait);
                };
            }

            toggleUserMenu() {
                this.userMenuDropdown?.classList.toggle('hidden');
            }

            toggleMobileMenu() {
                // If you have a mobile menu, implement this
                console.log('Mobile menu toggled');
            }

            capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            getIconForTab(tabId) {
                const icons = {
                    'home': 'fas fa-home',
                    'events': 'fas fa-calendar-alt',
                    'businesses': 'fas fa-store'
                };
                return icons[tabId] || 'fas fa-circle';
            }

            // --- Tab Switching ---
            switchTab(tabId, skipLoad = false) {
                if (this.state.activeTab === tabId) return;
                
                this.state.activeTab = tabId;
                
                // Update active state in navigation
                this.navLinks?.forEach(link => {
                    if (link.getAttribute('data-tab') === tabId) {
                        link.classList.add('text-blue-500');
                    } else {
                        link.classList.remove('text-blue-500');
                    }
                });
                
                // Show/hide content areas
                if (this.postsContainer) this.postsContainer.style.display = tabId === 'home' ? 'block' : 'none';
                if (this.eventsContainerMain) this.eventsContainerMain.style.display = tabId === 'events' ? 'block' : 'none';
                if (this.businessesContainerMain) this.businessesContainerMain.style.display = tabId === 'businesses' ? 'block' : 'none';
                
                // Load content if not already loaded
                if (!skipLoad) {
                    switch (tabId) {
                        case 'home':
                            if (this.state.posts.length === 0) this.loadPosts();
                            break;
                        case 'events':
                            if (this.state.events.length === 0) this.loadEvents();
                            break;
                        case 'businesses':
                            if (this.state.businesses.length === 0) this.loadBusinesses();
                            break;
                    }
                }
            }
        }

        // --- Global Init ---
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new PatwaApp();
        });
    </script>
</body>
</html>